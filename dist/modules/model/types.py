from typing import TypedDict, List, Union, Dict, Any
from modules.arima import IArimaConfig





## Predictions ##



# Prediction Meta Data
# This is the data that was used by the interpreter to come up with a result.
# The only parameter that is required is the description (d) which should always
# follow the pattern 'long-*' or 'short-*'
class IPredictionMetaData(TypedDict):
    # Interpretation Description
    d: str

    # List of predictions generated by Arima. Only present in ArimaModel Predictions
    # when cache is disabled.
    pl: Union[List[float], None]

    # Arima Model Prediction Results. Only present in DecisionModels
    pr: Union[List[int], None]

    # Up Probability. Only present in DecisionModels
    up: Union[float, None]

    # Down Probability. Only present in DecisionModels
    dp: Union[float, None]




# Prediction
# The final prediction dict generated by the model. It contains the result, the time
# in which the prediction was made and the metadata.
# For ArimaModels and DecisionModels, the md list will always contain one element.
# On the other side, MultiDecisionModels contain as many metadata elements as decision models
# and they also have identical indexing.
class IPrediction(TypedDict):
    # Prediction result: -1 | 0 | 1
    r: int

    # The time in which the prediction was performed (milliseconds)
    t: int

    # Prediction metadata: A SingleModel will always output a single IPredictionMetaData
    # whereas, MultiModels will output any number of IPredictionMetaData dictionaries
    md: List[IPredictionMetaData]










## ArimaModel ##



# Arima Interpreter Configuration
# The configuration used in order to interpret the model's predictions based on the 
# percentual change from the first to the last prediction.
class IArimaModelInterpreterConfig(TypedDict):
    long: float
    short: float





# ArimaModel Configuration
# The configuration that will be use to generate and interpret predictions.
class IArimaModelConfig(TypedDict):
    # The number of prediction candlesticks that will look into the past in order to make a prediction.
    lookback: int

    # The number of predictions to be generated by Arima
    predictions: int

    # Parameters for ARIMA(p,d,q)(P,D,Q)m
    arima: IArimaConfig

    # The interpreter that will determine the prediction's result
    interpreter: IArimaModelInterpreterConfig










## DecisionModel ##




## MultiDecisionModel ##





## Model ##


# Model
# The final state of an ArimaModel, DecisionModel or MultiDecisionModel once an instance is initialized.
# ArimaModel: Only takes an id and a single element in the arima_models list. 
class IModel(TypedDict):
    # Identity of the Model. If it is an Arima Model, it must follow the guidelines.
    id: str

    # The number of decision models that must agree in order to output a non-neutral prediction result.
    # This property only exists in MultiDeceisionModel
    consensus: Union[int, None]

    # The minimum probability required to output a non-neutral prediction result. Only present in 
    # DecisionModels & MultiDecisionModels
    minimum_probability: Union[float, None]

    # The list of ArimaModels that will be used to predict accordingly based on the type of model.
    arima_models: List[IArimaModelConfig]

    # @TODO
    decision_models: Union[List[Any], None]


















## Training Data ##




# Active Training Data Position
# When a position is opened, the active position dict is populated with the up and down price values
# as well as the predictions generated by the Single Models. Once the position closes, the row dict
# is completed with the up and down values
class ITrainingDataActivePosition(TypedDict):
    up_price: float         # The price in which the position will be closed as up
    down_price: float       # The price in which the position will be closed as down
    row: Dict[str, int]     # Model's features which will be completed with labels once the position closes








# Training Data Insights
# Data used to represent the proportions for the price changes and the position types generated by the 
# single models.
class ITrainingDataPriceActionsInsight(TypedDict):
    up: float
    down: float
class ITrainingDataPredictionInsight(TypedDict):
    long: float
    short: float
    neutral: float







# Training Data Config
# The Training configuration that resides in the configuration file and it is used to initialize
# the training data generator.
class ITrainingDataConfig(TypedDict):
    # The description of the Training Data that will be generated.
    description: str

    # Start and end time - If none provided, will use all the available data
    start: Union[str, int, None]
    end: Union[str, int, None]

    # Percentages that will determine if the price moved up or down after a position is opened
    up_percent_change: float
    down_percent_change: float

    # The list of ArimaModel configs that will be used
    arima_models: List[IModel]




# Training Data File
# The dict that contains all the information needed to train DecisionModels.
class ITrainingDataFile(ITrainingDataConfig):
    # Universally Unique Identifier (uuid4)
    id: str

    # Secondary Identifier generated based on the arima_models
    arima_id: str

    # The timestamp in which the Training Data was generated
    creation: int

    # Start and end time
    start: int  # First candlestick's ot
    end: int    # Last candlestick's ct

    # The number of minutes that took to generate the training data
    duration_minutes: int

    # Shape of the data
    rows: int
    columns: int

    # Price Actions Insight - The up and down percentage proportions
    price_actions_insight: ITrainingDataPriceActionsInsight

    # Prediction Insight 
    # Position type percentage proportions for each single model in this format:
    # {[modelID: str]: ITrainingDataPredictionInsight}
    predictions_insight: Dict[str, Dict[str, float]]

    # Training Data
    # The list of rows that are appended on position close. This is the data that
    # will be used to train models.
    training_data: List[Dict[str, int]]



