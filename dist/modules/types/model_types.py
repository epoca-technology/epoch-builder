from typing import TypedDict, List, Union, Dict, Literal
from modules.types.interpreter_types import IPercentChangeInterpreterConfig, IProbabilityInterpreterConfig, \
    IConsensusInterpreterConfig
from modules.types.keras_models_types import IKerasModelSummary
from modules.types.xgb_models_types import IXGBModelSummary








## Predictions ##





# Prediction Result
#  1 = Long
# -1 = Short
#  0 = Neutral
IPredictionResult = Literal[1, -1, 0]





# Prediction Meta Data
# This is the data that was used by the interpreter to come up with a result.
# The only parameter that is required is the description (d) which should always
# follow the pattern 'long-*',  'short-*' or 'neutral-*'. The other properties will 
# only be present if cache is disabled.
class IPredictionMetaData(TypedDict):
    # Interpretation Description
    d: str

    # List of predictions generated by a Regression as well as the price when it was generated.
    pl: Union[List[float], None]

    # Regression Features, Technical Analysis and any other data that could be included in the future.
    f: Union[List[int], None]

    # Up Probability. Only present in Classification Predictions.
    up: Union[float, None]

    # Down Probability. Only present in Classification Predictions.
    dp: Union[float, None]









# Prediction
# The final prediction dict generated by the model. It contains the result, the time
# in which the prediction was made and the metadata.
# For KerasRegressionModel, KerasClassificationModel, XGBRegressionModel and XGBClassification, the md list 
# will always contain one element. 
# On the other side, the ConsensusModel contains as many metadata elements as Classifications within. They 
# also have identical indexing.
class IPrediction(TypedDict):
    # Prediction result: -1 | 0 | 1
    r: IPredictionResult

    # The time in which the prediction was performed (milliseconds)
    t: int

    # Prediction Metadata
    md: List[IPredictionMetaData]










## Model Types ##


# Types of models supported by the project
IModelType = Literal[
    "KerasRegressionModel",         # KR_
    "KerasClassificationModel",     # KC_
    "XGBRegressionModel",           # XGBR_
    "XGBClassificationModel",       # XGBC_
    "ConsensusModel"                # CON_
]


# Trainable Model Types
ITrainableModelType = Literal[
    "keras_regression",     # KerasRegressionModel
    "keras_classification", # KerasClassificationModel
    "xgb_regression",       # XGBRegressionModel
    "xgb_classification"    # XGBClassificationModel
]


# Model ID Prefix
IModelIDPrefix = Literal[
    "KR_",     # KerasRegressionModel
    "KC_",     # KerasClassificationModel
    "XGBR_",   # XGBRegressionModel
    "XGBC_",   # XGBClassificationModel
    "CON_",    # ConsensusModel
]


# ModelType's Functions accept identifiers or prefixes.
IPrefixOrID = Union[IModelIDPrefix, str]


# The extension of trained models
ITrainableModelExtension = Literal["h5", "json"]










## Regression Configurations ##


# Regresion Configuration
# The general configuration that should be followed by regressions.
class IRegressionConfig(TypedDict):
    # The identifier of the model
    id: str

    # Important information regarding the model
    description: str

    # Regression Model Type
    # Default: will generate all predictions in one go.
    # Autoregressive: will generate 1 prediction at a time and feed it to itself as an input 
    autoregressive: bool

    # The number of candlesticks it will lookback to make a prediction
    lookback: int

    # The number of predictions it will generate
    predictions: int



# Keras Regresion Configuration
# The configuration that was used to train and will predict based on.
class IKerasRegressionConfig(IRegressionConfig):
    # The summary of the KerasModel
    summary: IKerasModelSummary


# XGBoost Regresion Configuration
# The configuration that was used to train and will predict based on.
class IXGBRegressionConfig(IRegressionConfig):
    # The summary of the XGBoostModel
    summary: IXGBModelSummary







## Classification Configurations ##


# Classification Configuration
# The general configuration that should be followed by classifications.
class IClassificationConfig(TypedDict):
    # The identifier of the model
    id: str

    # Important information regarding the trained model
    description: str

    # The identifier of the training data used
    training_data_id: str

    # The list of KerasRegressionModel|XGBRegressionModel attached to the Classification
    models: List[Dict] # IModel does not exist yet

    # Optional Technical Analysis Features
    include_rsi: bool       # Momentum
    include_aroon: bool     # Trend

    # The total number of features that will be used by the model to predict
    features_num: int



# Keras Classification Configuration
# The configuration that was used to train and will predict based on.
class IKerasClassificationConfig(IClassificationConfig):
    # The summary of the KerasModel
    summary: IKerasModelSummary




# XGBoost Classification Configuration
# The configuration that was used to train and will predict based on.
class IXGBClassificationConfig(IClassificationConfig):
    # The summary of the XGBoostModel
    summary: IXGBModelSummary












## RegressionModel Configurations ##



# RegressionModel Configuration
# The general configuration that should be followed by regression models.
class IRegressionModelConfig(TypedDict):
    # The ID of the saved regression model
    regression_id: str

    # The interpreter that will determine the prediction's result. This value is only present
    # when the function get_model is used.
    interpreter: Union[IPercentChangeInterpreterConfig, None]



# KerasRegressionModel Configuration
# The configuration used by the Keras Regression. Only exists when the model is initialized.
class IKerasRegressionModelConfig(IRegressionModelConfig):
    regression: Union[IKerasRegressionConfig, None]


# XGBRegressionModel Configuration
# The configuration used by the XGBoost Regression. Only exists when the model is initialized.
class IXGBRegressionModelConfig(IRegressionModelConfig):
    regression: Union[IXGBRegressionConfig, None]







## ClassificationModel Configurations ##


# ClassificationModel Configuration
# The general configuration that should be followed by classification models.
class IClassificationModelConfig(TypedDict):
    # The ID of the saved keras classification model
    classification_id: str

    # The interpreter that will determine the prediction's result. This value is only present
    # when the function get_model is used.
    interpreter: Union[IProbabilityInterpreterConfig, None]




# KerasClassificationModel Configuration
# The configuration used by the Keras Classification. Only exists when the model is initialized.
class IKerasClassificationModelConfig(IClassificationModelConfig):
    classification: Union[IKerasClassificationConfig, None]



# XGBClassificationModel Configuration
# The configuration used by the XGBoost Classification. Only exists when the model is initialized.
class IXGBClassificationModelConfig(IClassificationModelConfig):
    classification: Union[IXGBClassificationConfig, None]






# ConsensusModel Configuration
# The configuration that will be use to generate and interpret predictions.
class IConsensusModelConfig(TypedDict):
    # The list of KerasRegressionModel|KerasClassificationModel|XGBRegressionModel|
    # XGBClassificationModel attached to the ConsensusModel. This value is only populated 
    # when get_model is invoked
    sub_models: Union[List[Dict], None] # IModel does not exist yet.

    # The interpreter that will determine the prediction's result. Must represent at least 51%
    # of the provided sub models.
    interpreter: IConsensusInterpreterConfig










## Model ##



# Model
# The final state of a KerasRegressionModel|KerasClassificationModel|XGBRegressionModel|
# XGBClassificationModel|ConsensusModel once an 
# instance is initialized.
# The type of a model can be determined based on its configuration. Existing models are:
# 1) KerasRegressionModel: a model with a single keras_regression.
# 2) XGBRegressionModel: a model with a single xgb_regression.
# 3) KerasClassificationModel: a model with a single keras_classification.
# 4) XGBClassificationModel: a model with a single xgb_classification.
# 5) ConsensusModel: a model with any number of keras_classification|xgb_classification.
class IModel(TypedDict):
    # Identity of the Model. This value will be used by the cache system when storing/retrieving predictions.
    id: str

    # KerasRegression Configurations
    keras_regressions: Union[List[IKerasRegressionModelConfig], None]

    # XGBRegression Configurations
    xgb_regressions: Union[List[IXGBRegressionModelConfig], None]

    # KerasClassification Configurations
    keras_classifications: Union[List[IKerasClassificationModelConfig], None]

    # XGBClassification Configurations
    xgb_classifications: Union[List[IXGBClassificationModelConfig], None]

    # ConsensusModel Configuration
    consensus: Union[IConsensusModelConfig, None]























