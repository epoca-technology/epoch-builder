from typing import TypedDict, Union, Literal, Dict




## File Paths ##


# Configuration Files' Paths
# The Paths for all the configuration files that are used as input for many of the modules.
class IConfigPath(TypedDict):
    # Epoch's Configuration
    epoch: str

    # Backtest's Configuration
    backtest: str

    # Classification Training Data's Configuration
    classification_training_data: str

    # Keras Models Training's Configuration - These configurations are generated by Hyperparams
    keras_classification_training: str
    keras_regression_training: str

    # XGBoost Models Training's Configuration - These configurations are generated by Hyperparams
    xgb_classification_training: str
    xgb_regression_training: str





# Backtest Assets' Paths
# The paths for all the directories within the backtest_assets directory which are used
# to read and write results.
class IBacktestAssetsPath(TypedDict):
    # Backtest Assets Root Directory
    assets: str

    # Backtest Configurations grouped by position exit combination
    configurations: str

    # Backtest Results grouped by position exit combination
    results: str

    # Regression Selection Results
    regression_selection: str




# Model Assets' Paths
# The paths for all the directories within the model_assets directory.
class IModelAssetsPath(TypedDict):
    # Model Assets Root Directory
    assets: str

    # Batched training certificates grouped by trainable model type
    batched_training_certificates: str

    # Classification Training Data Files
    classification_training_data: str

    # Configurations to generate Classification Training Data Files
    classification_training_data_configs: str

    # Trained Models that can be used by the Software. Models that won't be exported
    # in the epoch should not be kept in this directory.
    models: str

    # All the models trained during the Epoch should be kept in this directory, grouped
    # by trainable model type.
    models_bank: str

    # Configurations generated by Hyperparams in order to train KerasClassification Models
    keras_classification_training_configs: str

    # Configurations generated by Hyperparams in order to train KerasRegression Models
    keras_regression_training_configs: str

    # Configurations generated by Hyperparams in order to train XGBClassification Models
    xgb_classification_training_configs: str

    # Configurations generated by Hyperparams in order to train XGBRegression Models
    xgb_regression_training_configs: str









## Position Exit Combinations ##




# Identifiers
IPositionExitCombinationID = Literal[
    "TP10_SL10", "TP10_SL15", "TP15_SL10", "TP15_SL15", "TP20_SL10", "TP20_SL15", 
    "TP10_SL20", "TP15_SL20", "TP20_SL20", "TP20_SL25", "TP25_SL20", "TP25_SL25",
    "TP25_SL30", "TP30_SL25", "TP20_SL30", "TP30_SL20", "TP30_SL30", "TP30_SL35",
    "TP35_SL30", "TP35_SL35", "TP35_SL40", "TP40_SL35", "TP30_SL40", "TP40_SL30",
    "TP40_SL40"
]


# Paths
IPositionExitCombinationPath = Literal[
    "01_TP10_SL10", "02_TP10_SL15", "03_TP15_SL10", "04_TP15_SL15", "05_TP20_SL10", "06_TP20_SL15", 
    "07_TP10_SL20", "08_TP15_SL20", "09_TP20_SL20", "10_TP20_SL25", "11_TP25_SL20", "12_TP25_SL25",
    "13_TP25_SL30", "14_TP30_SL25", "15_TP20_SL30", "16_TP30_SL20", "17_TP30_SL30", "18_TP30_SL35",
    "19_TP35_SL30", "20_TP35_SL35", "21_TP35_SL40", "22_TP40_SL35", "23_TP30_SL40", "24_TP40_SL30",
    "25_TP40_SL40"
]


# Position Exit Combination Record
class IPositionExitCombinationRecord(TypedDict):
    take_profit: float
    stop_loss: float
    path: IPositionExitCombinationPath


# Database containing all combination records
IPositionExitCombinationDatabase = Dict[IPositionExitCombinationID, IPositionExitCombinationRecord]









## Configuration ##



# Epoch Config
# The configuration to be used by the Epoch and influence the entire infrastructure.
class IEpochConfig(TypedDict):
    # Random seed to be set on all required libraries in order to guarantee reproducibility
    seed: int

    # Identifier, must be preffixed with "_". For example: "_EPOCHNAME"
    id: str

    # The range of the Epoch. These values are used for:
    # 1) Calculate the training evaluation range (epoch_width * 0.1)
    # 2) Calculate the backtest range (epoch_width * 0.2)
    start: int
    end: int

    # The training evaluation range is used for the following:
    # 1) Backtest ArimaModels in all position exit combinations
    # 2) Evaluate freshly trained Regression Models
    # 3) Backtest shortlisted RegressionModels in all position exit combinations
    # 4) Evaluate freshly trained Classification Models
    # training_evaluation_range = epoch_width * 0.1
    training_evaluation_start: int
    training_evaluation_end: int

    # The backtest range is used for the following:
    # 1) Backtest shortlisted ClassificationModels
    # 2) Backtest generated ConsensusModels
    # backtest_range = epoch_width * 0.2
    backtest_start: int
    backtest_end: int

    # Highest and lowest price within the Epoch.
    # If the price was to go above the highest or below the lowest price, trading should be
    # stopped and a new epoch should be published once the market is "stable"
    highest_price: float
    lowest_price: float

    # Regression Price Change Requirement
    # This value is used to evaluate Keras & XGB Regression Models. When creating an Epoch or 
    # training a regression, the best position exit combination is unknown and therefore it 
    # may require recurrent adjustments.
    # At the time of coding this module, after having completed the Arima Backtests in the _ALPHA
    # Epoch, the Regression Selection results pointed to TP30_SL30 as the best combination.
    regression_price_change_requirement: float

    # The number of minutes the model will remain idle when a position is closed during backtests
    idle_minutes_on_position_close: int

    # The identifier of the classification training data for unit tests
    ut_class_training_data_id: Union[str, None]

    # The Position Exit Combination that came victorious in the Regression Selection Process
    take_profit: Union[float, None]
    stop_loss: Union[float, None]





# Default values to speed up the creation process
class IEpochDefaults(TypedDict):
    epoch_width: int # Number of months that will comprise the Epoch
    seed: int
    regression_price_change_requirement: int
    idle_minutes_on_position_close: int
